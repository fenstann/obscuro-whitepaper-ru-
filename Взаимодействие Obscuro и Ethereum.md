# Взаимодействие Obscuro и Ethereum
Obscuro является конфиденциальным расширением для Ethereum, и поэтому активы должны свободно перемещаться между двумя сетями.

Все сайдчейны и L2-решения разработали способы для устранения несоответствий между различными моделями двух сетей, и, как правило, существует мостовой контракт, обеспечивающий безопасность активов. Разница между сайдчейнами и L2-решениями заключается в том, что несоответствия более существенны для сайдчейнов, поскольку они имеют свои собственные механизмы окончательного завершения и безопасности, и поэтому логика моста либо очень сложна, либо централизована.

## Депозиты
Пользователь вносит поддерживаемые токены ERC на известный адрес контракта моста, и как только транзакция успешно добавляется в блок, кошелек с поддержкой Obscuro автоматически создает транзакцию на L2, включая доказательство транзакции на L1. Точная сумма зачисляется обернутыми токенами на счет пользователя на Obscuro.

Тот факт, что окончательность транзакций на L1 носит вероятностный характер, делает зачисление средств на счет L2 непростой задачей. В основном, многие устраняют эту проблему путем ожидания периода подтверждения перед зачислением средств на счет. Obscuro же использует другой подход и вводит механизм зависимости между роллапами на L2 и блоками в L1.

Правило заключается в том, что роллап на L2, включающий транзакцию, которая зачисляет средства на счет Obscuro, имеет жесткую зависимость от блока в L1, и контракт Моста принудительно устанавливает, что он является одним из основателей текущего блока. Если транзакция депозита в L1 больше не входит в каноническую цепочку L1, это автоматически аннулирует роллап, содержащий транзакцию депозита на L2, и депозит в L1 будет признан в качестве основы для транзакции кредитования в роллапе на L2 только тогда, когда он будет включен в каноническую цепочку на L1.

Взаимодействие показано на следующей схеме:
![user registration](./images/user-registration.png)

Смотрите также раздел [Модель данных](./appendix#data-model) и следующую диаграмму зависимостей.
![deposit process](./images/deposit-process.png)

_Примечание: Транзакция депозита на L2 не может быть полностью зашифрована, поскольку агрегатор должен решить, включать ли ее в текущий роллап, основываясь на вероятности того, что блок в L1, от которого он зависит, является окончательным._

## Вывод средств
Высокоуровневое требование к функции вывода средств простое: позволить пользователям Obscuro перемещать активы обратно в сеть Ethereum. Проблема в том, что именно здесь кроется самая значительная угроза такому решению, поскольку может существовать большое количество заблокированных средств.

Задача состоит в том, чтобы реализовать эту функцию децентрализованным способом, определив протокол и экономические вознаграждения.

Из-за чувствительности этой функции, многие сайдчейны и L2-решения полагаются на технологию мульти-подписи для контроля разблокировки средств. Оптимистичные роллапы полагаются на механизм вызова в течение длительного периода ожидания перед выпуском средств, подкрепленных экономическими стимулами.

Obscuro использует технологию TEE, но не может воздействовать на данный аспекта из-за нашей модели угроз. Контракт моста мог бы выделять средства на основе подписи от сертифицированного TEE, если бы он был неуязвим, но поскольку это не так, решение заключается в использовании экономических стимулов поверх POBI протокола.

### Конечный результат при роллапе
Общее правило заключается в том, что снятие средств может быть обработано только тогда, когда роллап является _окончательным_. Это означает, что протокол был завершен в цепи Obscuro, а также, стал относителен цепи Ethereum.

#### Rule 1 - Стандартный период задержки
В обычном случае, роллап из канонической цепи (см. протокол POBI) является финальным, если с момента публикации в блоке Ethereum прошло стандартное количество блоков, соответствующее периоду в 1 день.
- Примечание 1: Период измеряется в блоках Ethereum, поскольку задержка между блоками в среднем стабильна.
- Примечание 2: Причина этого периода заключается в том, чтобы дать честным нодам возможность "оспорить" роллап, если он является неподлинным.
- Примечание 3: Период обратен количеству нод на L2. Он должен быть достаточно длинным, чтобы дать честным участникам шанс отреагировать и опубликовать информацию перед лицом агрессивных попыток цензуры против них, но достаточно коротким, чтобы не ухудшить пользовательский опыт. По нашим оценкам, когда сеть достигнет здорового количества нод, мы сможем сократить его количество до 50-100 блоков (~ 10 минут).

#### Правило 2 - Конкурирующие форки
Если предположить, что период, выбранный в правиле #1, достаточен, то единственная возможная атака, выполняемая агентом, который может взломать TEE, проявляется в виде нескольких параллельных форков глубиной не менее двух роллапов. Это происходит потому, что все действительные TEE выполняют один и тот же проверенный код, который выбирает одну и ту же каноническую цепочку из роллапов, опубликованных в блоке на L1, представленном в качестве доказательства. Если управляющий контракт замечает несколько форков, правило заключается в том, что окончательное завершение приостанавливается на всех форках, следовательно, приостанавливается и снятие средств. Аналогично, если один из форков становится неактивным, правило заключается в том, что все роллапы на живом форке становятся окончательными, как только пройдет стандартный период в 1 день с момента последнего блока в L1, содержащего роллап, опубликованный на неактивной ветке.
- Примечание1: Это правило превращает "Написанную" атаку в атаку "Отказа в обслуживании" на функции вывода.
- Примечание2: Если предположить, что есть честные участники, то действенные канонические леджеры продолжат расти, включая транзакции пользователей.
- Примечание3: Атакующему приходится тратить газ на Ethereum, чтобы поддерживать жизнь вредоносного форка.

#### Правило 3 - обращение к DoS об окончательности
Поскольку правило №2 превращает любую атаку в DoS-атаку, протокол имеет некоторые механизмы, позволяющие сохранить удовлетворительный пользовательский опыт даже в критичном случае взлома TEE.

1. Наибольшей поддержкой являются правила "Attestation Constraints". Форки, в канонической цепи, являются явным нарушением в протоколе, вызванным либо взломом TEE, либо взломом самого протокола. В конечном итоге это решается программным или, в худшем случае, аппаратным обновлением. Как только управляющий контракт принудительно обновится, злоумышленник больше не сможет создавать вредоносные роллапы, и, таким образом, форк станет неактивным, а окончательный статус возобновится на действующем форке.

2. Для всех пользователей, держащих ноду на L2, очевидно какая цепочка является канонической, поскольку именно она не дает сбоев. Маркет-мейкеры, работающие как на L1, так и на L2, могут вмешаться и поглотить запросы пользователей на вывод средств с небольшой скидкой, не принимая на себя никакого фактического риска.

Приведенные выше правила на практике предотвратят этот тип атаки, а если она произойдет, то предлагают практическое решение для пользователей. Кроме того, протокол имеет еще один запасной вариант на крайний случай, когда злоумышленник очень настойчив.

Модель управления сетью позволяет любому пользователю запустить _процедуру принудительного завершения_, сделав ставку или проголосовав за одну из конкурирующих цепочек роллапов. Минимальная ставка - это процент от сумм, выводимых на данной ветке, устанавливаемый через управление. Сторонники другой цепочки обязаны сделать ставку на аналогичную или более высокую сумму, чтобы участвовать в конкурсе. Процесс принятия решения проходит как аукцион, где проигравшая сторона также теряет свои ставки. После подведения итогов все роллапы на этой цепочке считаются окончательными, и происходит снятие средств.

### Протокол снятия средств
Каждый роллап, подписанный TEE, содержит список запросов на снятие средств в открытом виде. См: [Модель данных](./appendix#data-model).

Контракт моста отслеживает эти запросы и выполняет их в разное время, основываясь на статусе окончательности данного роллапа.

Процесс снятия показан на следующей диаграмме:
![withdrawal process](./images/withdrawal-process.png)


## Публичные мероприятия Obscuro
Разработчики приложений на Ethererum могут использовать конфиденциальный L2, такой как Obscuro, для выполнения некоторых задач, которые невозможно решить другим способом.

Например, смарт-контракт на L1 организует честную лотерею, для которой необходим надежный генератор случайных чисел, который майнеры не могут использовать в игре.

Другой пример - публикация результатов игры в покер, сыгранной внутри Obscuro, которые контракт на L1 можно использовать для осуществления платежа или обновления результатов турнира.

Сложность достижения этой функциональности заключается в том, что данные, поступающие из L2, должны быть окончательными.
К счастью, Obscuro уже имеет такой механизм для обработки снятия средств.
Приложения, работающие в Obscuro, могут создавать особые типы событий, называемые _Public Events_, которые OVM будет добавлять открытым текстом в специальную структуру данных в роллапе. 
Контракт _Rollup Contract_ сначала обрабатывает роллап, а затем, когда они достигают конца, происходит раскрытие этих события для внешних контрактов.

_Примечание: Справедливая лотерея может быть реализована в два этапа, чтобы избежать любого возможного влияния. Интерпритация может использовать технику подводной лодки и сначала опубликовать хэш этого числа в событии, а через несколько блоков опубликовать фактическое число в другом событии._
